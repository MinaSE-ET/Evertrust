{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Create New Certificate" }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <!-- Header Section -->
            <div class="text-center mb-5">
                <div class="d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; background: var(--gradient-primary); border-radius: 50%;">
                    <i class="fas fa-certificate fa-2x text-white"></i>
                </div>
                <h1 class="display-4 fw-bold text-gradient mb-2">{{ title|default:"Create New Certificate" }}</h1>
                <p class="lead text-muted">Complete the form below to create a new insurance certificate</p>
            </div>

            <!-- Progress Indicator -->
            <div class="progress mb-4" style="height: 8px; border-radius: 10px;">
                <div class="progress-bar bg-gradient-primary" role="progressbar" style="width: 0%" id="formProgress"></div>
            </div>

            <form method="post" class="needs-validation certificate-form" novalidate id="certificateForm">
                {% csrf_token %}
                
                <!-- Step Navigation -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-center">
                            <div class="step-nav">
                                <div class="step-item active" data-step="1">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Client Info</div>
                                </div>
                                <div class="step-item" data-step="2">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Insurance Details</div>
                                </div>
                                <div class="step-item" data-step="3">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Coverage & Premiums</div>
                                </div>
                                <div class="step-item" data-step="4">
                                    <div class="step-number">4</div>
                                    <div class="step-label">Additional Info</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Client Information -->
                <div class="form-step active" data-step="1">
                    <div class="card border-0 shadow-lg hover-lift">
                        <div class="card-header bg-gradient-primary text-white">
                            <h3 class="mb-0">
                                <i class="fas fa-user me-3"></i>Client Information
                            </h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_name }}
                                        <label for="{{ form.client_name.id_for_label }}">{{ form.client_name.label }}</label>
                                        {% if form.client_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_email }}
                                        <label for="{{ form.client_email.id_for_label }}">{{ form.client_email.label }}</label>
                                        {% if form.client_email.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_email.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_phone }}
                                        <label for="{{ form.client_phone.id_for_label }}">{{ form.client_phone.label }}</label>
                                        {% if form.client_phone.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_phone.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_id_number }}
                                        <label for="{{ form.client_id_number.id_for_label }}">{{ form.client_id_number.label }}</label>
                                        {% if form.client_id_number.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_id_number.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_date_of_birth }}
                                        <label for="{{ form.client_date_of_birth.id_for_label }}">{{ form.client_date_of_birth.label }}</label>
                                        {% if form.client_date_of_birth.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_date_of_birth.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_address }}
                                        <label for="{{ form.client_address.id_for_label }}">{{ form.client_address.label }}</label>
                                        {% if form.client_address.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_address.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_bank_name }}
                                        <label for="{{ form.client_bank_name.id_for_label }}">{{ form.client_bank_name.label }}</label>
                                        {% if form.client_bank_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_bank_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.client_bank_account }}
                                        <label for="{{ form.client_bank_account.id_for_label }}">{{ form.client_bank_account.label }}</label>
                                        {% if form.client_bank_account.errors %}
                                            <div class="invalid-feedback d-block">{{ form.client_bank_account.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Insurance Details -->
                <div class="form-step" data-step="2">
                    <div class="card border-0 shadow-lg hover-lift">
                        <div class="card-header bg-gradient-success text-white">
                            <h3 class="mb-0">
                                <i class="fas fa-shield-alt me-3"></i>Insurance Details
                            </h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.certificate_type }}
                                        <label for="{{ form.certificate_type.id_for_label }}">{{ form.certificate_type.label }}</label>
                                        {% if form.certificate_type.errors %}
                                            <div class="invalid-feedback d-block">{{ form.certificate_type.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.coverage_level }}
                                        <label for="{{ form.coverage_level.id_for_label }}">{{ form.coverage_level.label }}</label>
                                        {% if form.coverage_level.errors %}
                                            <div class="invalid-feedback d-block">{{ form.coverage_level.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.policy_number }}
                                        <label for="{{ form.policy_number.id_for_label }}">{{ form.policy_number.label }}</label>
                                        {% if form.policy_number.errors %}
                                            <div class="invalid-feedback d-block">{{ form.policy_number.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.status }}
                                        <label for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.payment_status }}
                                        <label for="{{ form.payment_status.id_for_label }}">{{ form.payment_status.label }}</label>
                                        {% if form.payment_status.errors %}
                                            <div class="invalid-feedback d-block">{{ form.payment_status.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.agent_name }}
                                        <label for="{{ form.agent_name.id_for_label }}">{{ form.agent_name.label }}</label>
                                        {% if form.agent_name.errors %}
                                            <div class="invalid-feedback d-block">{{ form.agent_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.agent_id }}
                                        <label for="{{ form.agent_id.id_for_label }}">{{ form.agent_id.label }}</label>
                                        {% if form.agent_id.errors %}
                                            <div class="invalid-feedback d-block">{{ form.agent_id.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.location }}
                                        <label for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                                        {% if form.location.errors %}
                                            <div class="invalid-feedback d-block">{{ form.location.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.activity }}
                                        <label for="{{ form.activity.id_for_label }}">{{ form.activity.label }}</label>
                                        {% if form.activity.errors %}
                                            <div class="invalid-feedback d-block">{{ form.activity.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.description_of_risk }}
                                        <label for="{{ form.description_of_risk.id_for_label }}">{{ form.description_of_risk.label }}</label>
                                        {% if form.description_of_risk.errors %}
                                            <div class="invalid-feedback d-block">{{ form.description_of_risk.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Coverage & Premiums -->
                <div class="form-step" data-step="3">
                    <div class="card border-0 shadow-lg hover-lift">
                        <div class="card-header bg-gradient-warning text-white">
                            <h3 class="mb-0">
                                <i class="fas fa-dollar-sign me-3"></i>Coverage & Premiums
                            </h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white">$</span>
                                            {{ form.insured_amount }}
                                        </div>
                                        <label for="{{ form.insured_amount.id_for_label }}">{{ form.insured_amount.label }}</label>
                                        {% if form.insured_amount.errors %}
                                            <div class="invalid-feedback d-block">{{ form.insured_amount.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-success text-white">$</span>
                                            {{ form.premium_amount }}
                                        </div>
                                        <label for="{{ form.premium_amount.id_for_label }}">{{ form.premium_amount.label }}</label>
                                        {% if form.premium_amount.errors %}
                                            <div class="invalid-feedback d-block">{{ form.premium_amount.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-info text-white">$</span>
                                            {{ form.total_premium }}
                                        </div>
                                        <label for="{{ form.total_premium.id_for_label }}">{{ form.total_premium.label }}</label>
                                        {% if form.total_premium.errors %}
                                            <div class="invalid-feedback d-block">{{ form.total_premium.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-secondary text-white">$</span>
                                            {{ form.net_contribution }}
                                        </div>
                                        <label for="{{ form.net_contribution.id_for_label }}">{{ form.net_contribution.label }}</label>
                                        {% if form.net_contribution.errors %}
                                            <div class="invalid-feedback d-block">{{ form.net_contribution.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-warning text-white">$</span>
                                            {{ form.proportional_stamp }}
                                        </div>
                                        <label for="{{ form.proportional_stamp.id_for_label }}">{{ form.proportional_stamp.label }}</label>
                                        {% if form.proportional_stamp.errors %}
                                            <div class="invalid-feedback d-block">{{ form.proportional_stamp.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-danger text-white">$</span>
                                            {{ form.dimensional_stamp }}
                                        </div>
                                        <label for="{{ form.dimensional_stamp.id_for_label }}">{{ form.dimensional_stamp.label }}</label>
                                        {% if form.dimensional_stamp.errors %}
                                            <div class="invalid-feedback d-block">{{ form.dimensional_stamp.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-info text-white">$</span>
                                            {{ form.supervision_fees }}
                                        </div>
                                        <label for="{{ form.supervision_fees.id_for_label }}">{{ form.supervision_fees.label }}</label>
                                        {% if form.supervision_fees.errors %}
                                            <div class="invalid-feedback d-block">{{ form.supervision_fees.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white">$</span>
                                            {{ form.insurance_fees }}
                                        </div>
                                        <label for="{{ form.insurance_fees.id_for_label }}">{{ form.insurance_fees.label }}</label>
                                        {% if form.insurance_fees.errors %}
                                            <div class="invalid-feedback d-block">{{ form.insurance_fees.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.total_premium_words }}
                                        <label for="{{ form.total_premium_words.id_for_label }}">{{ form.total_premium_words.label }}</label>
                                        {% if form.total_premium_words.errors %}
                                            <div class="invalid-feedback d-block">{{ form.total_premium_words.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Additional Information -->
                <div class="form-step" data-step="4">
                    <div class="card border-0 shadow-lg hover-lift">
                        <div class="card-header bg-gradient-info text-white">
                            <h3 class="mb-0">
                                <i class="fas fa-calendar-alt me-3"></i>Additional Information
                            </h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.period_from }}
                                        <label for="{{ form.period_from.id_for_label }}">{{ form.period_from.label }}</label>
                                        {% if form.period_from.errors %}
                                            <div class="invalid-feedback d-block">{{ form.period_from.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.period_to }}
                                        <label for="{{ form.period_to.id_for_label }}">{{ form.period_to.label }}</label>
                                        {% if form.period_to.errors %}
                                            <div class="invalid-feedback d-block">{{ form.period_to.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.start_date }}
                                        <label for="{{ form.start_date.id_for_label }}">{{ form.start_date.label }}</label>
                                        {% if form.start_date.errors %}
                                            <div class="invalid-feedback d-block">{{ form.start_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        {{ form.end_date }}
                                        <label for="{{ form.end_date.id_for_label }}">{{ form.end_date.label }}</label>
                                        {% if form.end_date.errors %}
                                            <div class="invalid-feedback d-block">{{ form.end_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.description }}
                                        <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                                        {% if form.description.errors %}
                                            <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.terms_conditions }}
                                        <label for="{{ form.terms_conditions.id_for_label }}">{{ form.terms_conditions.label }}</label>
                                        {% if form.terms_conditions.errors %}
                                            <div class="invalid-feedback d-block">{{ form.terms_conditions.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <div class="form-floating">
                                        {{ form.special_conditions }}
                                        <label for="{{ form.special_conditions.id_for_label }}">{{ form.special_conditions.label }}</label>
                                        {% if form.special_conditions.errors %}
                                            <div class="invalid-feedback d-block">{{ form.special_conditions.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary btn-lg" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </button>
                    
                    <div class="d-flex gap-3">
                        <button type="button" class="btn btn-outline-primary btn-lg" id="nextBtn">
                            Next<i class="fas fa-arrow-right ms-2"></i>
                        </button>
                        
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" style="display: none;">
                            <i class="fas fa-save me-2"></i>Create Certificate
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Enhanced CSS for the form -->
<style>
.step-nav {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.step-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--light-bg);
    border: 3px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    color: var(--text-secondary);
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
}

.step-item.active .step-number {
    background: var(--gradient-primary);
    border-color: var(--primary-color);
    color: white;
    transform: scale(1.1);
}

.step-item.completed .step-number {
    background: var(--gradient-success);
    border-color: var(--success-color);
    color: white;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-align: center;
}

.step-item.active .step-label {
    color: var(--primary-color);
}

.step-item.completed .step-label {
    color: var(--success-color);
}

.form-step {
    display: none;
    animation: fadeIn 0.5s ease;
}

.form-step.active {
    display: block;
}

.form-floating {
    position: relative;
}

.form-floating .form-control {
    height: 3.5rem;
    padding: 1rem 0.75rem;
    border-radius: 0.75rem;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.form-floating .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
    transform: translateY(-2px);
}

.form-floating label {
    padding: 1rem 0.75rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.form-floating .form-control:focus + label,
.form-floating .form-control:not(:placeholder-shown) + label {
    transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
    color: var(--primary-color);
    font-weight: 600;
}

.input-group-text {
    border: 2px solid var(--border-color);
    border-right: none;
    font-weight: 600;
}

.input-group .form-control {
    border-left: none;
}

.input-group .form-control:focus {
    border-left: none;
}

.card {
    border-radius: 1.5rem;
    overflow: hidden;
}

.card-header {
    border: none;
    padding: 1.5rem 2rem;
    font-weight: 700;
}

.card-body {
    padding: 2rem;
}

.btn {
    border-radius: 1rem;
    font-weight: 600;
    padding: 1rem 2rem;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.progress {
    background: var(--light-bg);
    border-radius: 1rem;
    overflow: hidden;
}

.progress-bar {
    background: var(--gradient-primary);
    transition: width 0.5s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .step-nav {
        gap: 1rem;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .step-label {
        font-size: 0.75rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .btn {
        padding: 0.875rem 1.5rem;
    }
}
</style>

<!-- Enhanced JavaScript for form functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('certificateForm');
    const steps = document.querySelectorAll('.form-step');
    const stepItems = document.querySelectorAll('.step-item');
    const progressBar = document.getElementById('formProgress');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    let currentStep = 1;
    const totalSteps = steps.length;
    
    // Initialize form
    updateStepDisplay();
    updateProgress();
    
    // Next button functionality
    nextBtn.addEventListener('click', function() {
        if (validateCurrentStep()) {
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepDisplay();
                updateProgress();
            }
        }
    });
    
    // Previous button functionality
    prevBtn.addEventListener('click', function() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
            updateProgress();
        }
    });
    
    // Step navigation
    stepItems.forEach((item, index) => {
        item.addEventListener('click', function() {
            const stepNumber = parseInt(this.dataset.step);
            if (stepNumber <= currentStep || canNavigateToStep(stepNumber)) {
                currentStep = stepNumber;
                updateStepDisplay();
                updateProgress();
            }
        });
    });
    
    function updateStepDisplay() {
        steps.forEach((step, index) => {
            if (index + 1 === currentStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        stepItems.forEach((item, index) => {
            const stepNumber = index + 1;
            item.classList.remove('active', 'completed');
            
            if (stepNumber === currentStep) {
                item.classList.add('active');
            } else if (stepNumber < currentStep) {
                item.classList.add('completed');
            }
        });
        
        // Update button visibility
        if (currentStep === 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        } else if (currentStep === totalSteps) {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
        } else {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        }
    }
    
    function updateProgress() {
        const progress = (currentStep / totalSteps) * 100;
        progressBar.style.width = progress + '%';
    }
    
    function validateCurrentStep() {
        const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
        const requiredFields = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        return isValid;
    }
    
    function canNavigateToStep(stepNumber) {
        // Allow navigation to completed steps or current step
        return stepNumber <= currentStep;
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        if (!validateCurrentStep()) {
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Certificate...';
        submitBtn.disabled = true;
    });
    
    // Auto-save functionality (optional)
    let autoSaveTimer;
    const formFields = form.querySelectorAll('input, select, textarea');
    
    formFields.forEach(field => {
        field.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                // Save form data to localStorage
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                localStorage.setItem('certificateFormData', JSON.stringify(data));
            }, 1000);
        });
    });
    
    // Load saved form data
    const savedData = localStorage.getItem('certificateFormData');
    if (savedData) {
        const data = JSON.parse(savedData);
        Object.keys(data).forEach(key => {
            const field = form.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = data[key];
            }
        });
    }
    
    // Clear saved data on successful submission
    form.addEventListener('submit', function() {
        localStorage.removeItem('certificateFormData');
    });
});
</script>
{% endblock %} 